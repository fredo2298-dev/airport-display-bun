<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Aeropuerto Gerardo Tovar López – BUN | Arrivals & Departures</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Day.js for time handling -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- SheetJS for reading XLSX files -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html, body { height: 100%; }
    .badge { padding: .125rem .5rem; border-radius: 999px; font-size: 0.75rem; }
  </style>
</head>
<body class="bg-slate-950 text-slate-100">
  <div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
      <div class="flex items-center gap-3">
        <img id="logoEl" alt="Airport Logo" class="h-10 w-10 hidden" />
        <div>
          <h1 id="airportTitle" class="text-2xl md:text-3xl font-semibold">Aeropuerto Gerardo Tovar López – BUN</h1>
          <p id="clock" class="text-slate-400">—</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnFullscreen" class="px-3 py-2 rounded-2xl bg-slate-800 hover:bg-slate-700">Fullscreen</button>
        <button id="btnRefresh" class="px-3 py-2 rounded-2xl bg-slate-800 hover:bg-slate-700">Refresh</button>
      </div>
    </div>

    <!-- Controls -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
      <input id="search" type="text" placeholder="Search flight, city…" class="px-3 py-2 rounded-2xl bg-slate-900 border border-slate-800 placeholder-slate-400" />
      <select id="fltType" class="px-3 py-2 rounded-2xl bg-slate-900 border border-slate-800">
        <option value="arrivals">Arrivals</option>
        <option value="departures">Departures</option>
      </select>
      <select id="airlineFilter" class="px-3 py-2 rounded-2xl bg-slate-900 border border-slate-800">
        <option value="">All airlines</option>
      </select>
      <select id="statusFilter" class="px-3 py-2 rounded-2xl bg-slate-900 border border-slate-800">
        <option value="">All status</option>
        <option>On Time</option>
        <option>Delayed</option>
        <option>Boarding</option>
        <option>Cancelled</option>
        <option>Landed</option>
        <option>Departed</option>
      </select>
    </div>

    <!-- Table -->
    <div class="overflow-auto rounded-2xl border border-slate-800">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-900/60 sticky top-0">
          <tr class="text-left">
            <th class="px-4 py-3 font-semibold">Flight</th>
            <th class="px-4 py-3 font-semibold" id="colRoute">From</th>
            <th class="px-4 py-3 font-semibold">Scheduled</th>
            <th class="px-4 py-3 font-semibold">Est/Act</th>
            <th class="px-4 py-3 font-semibold">Status</th>
            <th class="px-4 py-3 font-semibold">Gate/Belt</th>
            <th class="px-4 py-3 font-semibold">Airline</th>
          </tr>
        </thead>
        <tbody id="rows" class="divide-y divide-slate-900/50"></tbody>
      </table>
    </div>

    <div class="mt-3 text-xs text-slate-400">
      Data updates every <span id="refreshSec">60</span>s • Add <code>?airport=BUN</code>, <code>?data=URL</code>, optional <code>?logo=URL</code>, and <code>?refresh=ms</code>.
    </div>
  </div>

  <script>
    // --- Setup ---
    dayjs.extend(dayjs_plugin_utc);
    dayjs.extend(dayjs_plugin_timezone);
    const TZ = "America/Bogota";

    const qs = new URLSearchParams(location.search);
    const AIRPORT = qs.get("airport") || "Aeropuerto Gerardo Tovar López – BUN";
    const DATA_URL = qs.get("data") || "flights_sample.csv"; // default to bundled sample
    const REFRESH_MS = Number(qs.get("refresh")) || 60000;
    const LOGO_URL = qs.get("logo") || "";

    document.getElementById("airportTitle").textContent = `${AIRPORT} — Arrivals & Departures`;
    document.getElementById("refreshSec").textContent = Math.round(REFRESH_MS / 1000);
    if (LOGO_URL) {
      const logoEl = document.getElementById('logoEl');
      logoEl.src = LOGO_URL; logoEl.classList.remove('hidden');
    }

    // Live clock
    function tickClock() {
      document.getElementById("clock").textContent = dayjs().tz(TZ).format("dddd, MMM D YYYY • HH:mm z");
    }
    tickClock();
    setInterval(tickClock, 1000);

    // UI elements
    const rowsEl = document.getElementById("rows");
    const flightTypeEl = document.getElementById("fltType");
    const airlineFilterEl = document.getElementById("airlineFilter");
    const statusFilterEl = document.getElementById("statusFilter");
    const searchEl = document.getElementById("search");
    const colRouteEl = document.getElementById("colRoute");

    // Sample fallback data
    const SAMPLE = [
      { type: "arrival", flight: "AV 8123", airline: "Avianca", from: "Bogotá (BOG)", to: "", scheduled: "2026-01-18T10:20:00-05:00", estimated: "2026-01-18T10:30:00-05:00", status: "Delayed", terminal: "T1", gate: "", belt: "1" },
      { type: "arrival", flight: "LA 4012", airline: "LATAM", from: "Cali (CLO)", to: "", scheduled: "2026-01-18T11:00:00-05:00", estimated: "2026-01-18T11:00:00-05:00", status: "On Time", terminal: "T1", gate: "", belt: "2" },
      { type: "departure", flight: "AV 8124", airline: "Avianca", from: "", to: "Bogotá (BOG)", scheduled: "2026-01-18T11:45:00-05:00", estimated: "2026-01-18T11:55:00-05:00", status: "Boarding", terminal: "T1", gate: "3", belt: "" },
      { type: "departure", flight: "VE 219", airline: "Viva Air", from: "", to: "Medellín (MDE)", scheduled: "2026-01-18T13:10:00-05:00", estimated: "2026-01-18T13:10:00-05:00", status: "On Time", terminal: "T1", gate: "2", belt: "" }
    ];

    let allData = [];

    // --- Data loading ---
    async function fetchText(url) {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`Failed to fetch ${url}: ${res.status}`);
      return { res, arrayBuffer: () => res.arrayBuffer(), text: () => res.text(), contentType: (res.headers.get('content-type') || '').toLowerCase() };
    }

    function normalizeArray(arr) {
      return arr.map(r => ({
        type: (r.type || r.Type || '').toString().trim().toLowerCase().startsWith('dep') ? 'departure'
             : (r.type || r.Type || '').toString().trim().toLowerCase().startsWith('arr') ? 'arrival'
             : (r.type || r.Type || 'arrival'),
        flight: r.flight || r.Flight || r.flightNo || r.FlightNo || '',
        airline: r.airline || r.Airline || '',
        from: r.from || r.From || r.origin || r.Origin || '',
        to: r.to || r.To || r.destination || r.Destination || '',
        scheduled: r.scheduled || r.Scheduled || r.Sched || '',
        estimated: r.estimated || r.Estimated || r.Est || r.actual || r.Actual || '',
        status: r.status || r.Status || '',
        terminal: r.terminal || r.Terminal || '',
        gate: r.gate || r.Gate || '',
        belt: r.belt || r.Belt || r.carousel || r.Carousel || ''
      }));
    }

    async function fetchData() {
      if (!DATA_URL) return SAMPLE;
      try {
        const { res, text, arrayBuffer, contentType } = await fetchText(DATA_URL);
        // If XLSX
        if (contentType.includes('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') || DATA_URL.toLowerCase().endsWith('.xlsx')) {
          const ab = await arrayBuffer();
          const wb = XLSX.read(ab, { type: 'array' });
          const sheetName = wb.SheetNames[0];
          const json = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], { defval: '' });
          return normalizeArray(json);
        }
        // Try JSON
        try {
          if (contentType.includes('application/json') || DATA_URL.toLowerCase().endsWith('.json')) {
            const t = await text();
            const json = JSON.parse(t);
            return normalizeArray(Array.isArray(json) ? json : (json.rows || []));
          }
        } catch (e) { /* ignore and try CSV */ }
        // CSV fallback
        const t = await text();
        const parsed = Papa.parse(t.trim(), { header: true, skipEmptyLines: true });
        return normalizeArray(parsed.data);
      } catch (e) {
        console.error(e);
        return SAMPLE;
      }
    }

    function badgeClass(status) {
      const s = (status || '').toLowerCase();
      if (s.includes('cancel')) return 'badge bg-red-600/20 text-red-300 border border-red-700';
      if (s.includes('delay')) return 'badge bg-amber-600/20 text-amber-300 border border-amber-700';
      if (s.includes('board')) return 'badge bg-blue-600/20 text-blue-300 border border-blue-700';
      if (s.includes('land')) return 'badge bg-emerald-600/20 text-emerald-300 border border-emerald-700';
      if (s.includes('depart')) return 'badge bg-indigo-600/20 text-indigo-300 border border-indigo-700';
      if (s.includes('on time')) return 'badge bg-emerald-600/20 text-emerald-300 border border-emerald-700';
      return 'badge bg-slate-600/20 text-slate-200 border border-slate-700';
    }

    function fmt(t) {
      if (!t) return '—';
      const d = dayjs(t);
      if (!d.isValid()) return '—';
      return d.tz(TZ).format('HH:mm');
    }

    function applyFilters(data) {
      const type = document.getElementById('fltType').value;
      const airline = document.getElementById('airlineFilter').value;
      const status = document.getElementById('statusFilter').value;
      const q = (document.getElementById('search').value || '').toLowerCase();

      let filtered = data.filter(d => d.type === (type === 'arrivals' ? 'arrival' : 'departure'));

      if (airline) filtered = filtered.filter(d => (d.airline || '') === airline);
      if (status) filtered = filtered.filter(d => (d.status || '') === status);
      if (q) {
        filtered = filtered.filter(d =>
          (d.flight || '').toLowerCase().includes(q) ||
          (d.from || '').toLowerCase().includes(q) ||
          (d.to || '').toLowerCase().includes(q) ||
          (d.airline || '').toLowerCase().includes(q)
        );
      }

      filtered.sort((a, b) => new Date(a.scheduled || 0) - new Date(b.scheduled || 0));

      return filtered;
    }

    function render() {
      const isArr = document.getElementById('fltType').value === 'arrivals';
      document.getElementById('colRoute').textContent = isArr ? 'From' : 'To';

      const data = applyFilters(allData);
      rowsEl.innerHTML = data.map(d => `
        <tr class="hover:bg-slate-900/50">
          <td class="px-4 py-3 font-medium">${d.flight || '—'}</td>
          <td class="px-4 py-3">${isArr ? (d.from || '—') : (d.to || '—')}</td>
          <td class="px-4 py-3">${fmt(d.scheduled)}</td>
          <td class="px-4 py-3">${fmt(d.estimated)}</td>
          <td class="px-4 py-3"><span class="${badgeClass(d.status)}">${d.status || '—'}</span></td>
          <td class="px-4 py-3">${(d.gate || d.belt) ? [d.gate, d.belt].filter(Boolean).join(' / ') : '—'}</td>
          <td class="px-4 py-3">${d.airline || '—'}</td>
        </tr>
      `).join('');

      // Fill airline dropdown from data
      const airlines = [...new Set(allData.map(d => d.airline).filter(Boolean))].sort();
      const sel = airlineFilterEl.value;
      airlineFilterEl.innerHTML = `<option value="">All airlines</option>` + airlines.map(a => `<option ${a===sel?'selected':''}>${a}</option>`).join('');
    }

    async function refresh() {
      const data = await fetchData();
      allData = data;
      render();
    }

    // Event wiring
    [flightTypeEl, airlineFilterEl, statusFilterEl].forEach(el => el.addEventListener('change', render));
    searchEl.addEventListener('input', render);
    document.getElementById('btnRefresh').addEventListener('click', refresh);
    document.getElementById('btnFullscreen').addEventListener('click', () => {
      if (!document.fullscreenElement) document.documentElement.requestFullscreen();
      else document.exitFullscreen();
    });

    // Initial load + auto-refresh
    refresh();
    setInterval(refresh, REFRESH_MS);
  </script>
</body>
</html>
